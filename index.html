<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>KinematicTrees</title>
    <style>
        body { margin: 0; overflow: hidden; }

        /* Simple overlay UI */
        #robot-ui {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 10;
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px 10px;
            background: rgba(0,0,0,0.55);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            backdrop-filter: blur(6px);
        }
        #robot-ui select, #robot-ui button {
            font: inherit;
        }
        #robot-status {
            opacity: 0.8;
            min-width: 90px;
        }
    </style>
</head>
<body>

<div id="robot-ui">
    <label for="robotSelect">Robot</label>
    <select id="robotSelect">
        <option value="page1/">page1</option>
        <option value="page2/">page2</option>
        <option value="uploaded/">uploaded (latest)</option>
    </select>
    <button id="reloadBtn" type="button">Reload</button>
    <input id="uploadFolder" type="file" webkitdirectory directory multiple style="max-width:220px" />
    <button id="processBtn" type="button">Process Upload</button>
    <span id="robot-status"></span>
</div>

<script type="module">
    import { init } from '/src/main.js';

    const select = document.getElementById('robotSelect');
    const reloadBtn = document.getElementById('reloadBtn');
    const processBtn = document.getElementById('processBtn');
    const uploadFolder = document.getElementById('uploadFolder');
    const statusEl = document.getElementById('robot-status');

    const setStatus = (s) => { statusEl.textContent = s ?? ''; };

    // Start app with initial selection
    const appPromise = init(select.value, { setStatus });

    const loadSelected = async () => {
        const app = await appPromise;
        await app.loadRobot(select.value);
    };

    async function processUploadedFolder() {
        const files = uploadFolder.files;
        if (!files || files.length === 0) {
            setStatus('Pick a folder first');
            return;
        }

        const form = new FormData();
        for (const f of files) {
            const rel = f.webkitRelativePath || f.name;
            form.append('files', f);
            form.append('paths', rel);
        }

        setStatus(`Processing ${files.length} files...`);
        const res = await fetch('http://localhost:8080/api/process', {
            method: 'POST',
            body: form,
        });

        if (!res.ok) {
            const txt = await res.text();
            throw new Error(txt || `process failed (${res.status})`);
        }

        select.value = 'uploaded/';
        await loadSelected();
        setStatus('Uploaded model processed and loaded');
    }

    // Hot-swap on selection change
    select.addEventListener('change', loadSelected);

    // Optional manual reload
    reloadBtn.addEventListener('click', loadSelected);

    processBtn.addEventListener('click', async () => {
        try {
            await processUploadedFolder();
        } catch (e) {
            console.error(e);
            setStatus(`Process failed: ${e.message || e}`);
        }
    });
</script>

</body>
</html>
